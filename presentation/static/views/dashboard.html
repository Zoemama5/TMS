<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard</title>
  </head>
  <body>
    <h1>Dashboard</h1>
    <p id="welcome">Loading...</p>
    <button id="logoutBtn">Logout</button>
    <script>
      console.log('âœ… Dashboard script loaded!');

      // STEP 1: Read from URL hash (Google OAuth redirect)
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const tokenFromUrl = params.get('token');
      const emailFromUrl = params.get('email');
      const nameFromUrl = params.get('name');

      console.log('ðŸ” Token from URL:', tokenFromUrl);

      // STEP 2: If token exists in URL, store it in localStorage
      if (tokenFromUrl) {
        console.log('ðŸ’¾ Storing token from URL to localStorage...');
        localStorage.setItem('token', tokenFromUrl);
        localStorage.setItem(
          'user',
          JSON.stringify({ email: emailFromUrl, name: nameFromUrl })
        );

        // Clean URL so hash disappears
        window.history.replaceState(
          {},
          document.title,
          window.location.pathname
        );
      }

      // STEP 3: Get token from localStorage
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');

      console.log('ðŸ§© Token from localStorage:', token);
      console.log('ðŸ‘¤ User from localStorage:', user);

      // STEP 4: Handle missing token
      if (!token) {
        console.warn('âŒ No token found, redirecting to login page...');
        document.getElementById('message').innerText =
          'No token found. Please login again.';
        window.location.href = '/auth/login-page';
      } else {
        // STEP 5: Fetch protected dashboard route
        console.log('ðŸ“¡ Sending token to /auth/dashboard...');
        fetch('/auth/dashboard', {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => {
            console.log('ðŸ” Dashboard response status:', res.status);
            return res.json();
          })
          .then((data) => {
            console.log('âœ… Dashboard data:', data);
            document.getElementById('welcome').innerText = data.message;
          })
          .catch((err) => {
            console.error('âŒ Dashboard fetch error:', err);
            document.getElementById('message').innerText =
              'Error loading dashboard.';
          });
      }

      // STEP 6: Logout clears token
      document.getElementById('logoutBtn').addEventListener('click', () => {
        console.log('ðŸšª Logging out...');
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/auth/login-page';
      });
    </script>
  </body>
</html>
